<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pangram Aid</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; worker-src 'self'; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; connect-src 'self'; img-src 'self' data:; upgrade-insecure-requests">
  <style>
    :root { --ok:#22c55e; --bad:#ef4444; --zero:#9ca3af; --bg:#0b0c0f; --card:#111318; --ink:#e5e7eb; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--ink); background:var(--bg); }
    header { padding:16px; text-align:center; font-weight:600; letter-spacing:.2px; }
    .wrap { display:grid; gap:16px; padding:16px; max-width:960px; margin:0 auto; }
    textarea { width:100%; min-height:auto; padding:14px 16px; border-radius:16px; background:var(--card); color:var(--ink); border:1px solid #1f2430; outline:none; font-size:16px; resize:none; overflow:hidden; }
    .panel { background:var(--card); border:1px solid #1f2430; border-radius:16px; padding:12px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(56px,1fr)); gap:10px; }
    .cell { display:flex; flex-direction:column; align-items:center; gap:6px; padding:10px 8px; border-radius:12px; background:#0f1116; border:1px solid #1f2430; }
    .ltr { font-weight:700; font-variant-ligatures:none; }
    .cnt { font-weight:700; padding:.25rem .6rem; border-radius:999px; line-height:1; border:1px solid #1f2430; }
    .zero { color:var(--zero); }
    .one { color:var(--ok); }
    .many { color:var(--bad); }
    .totals { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:10px; font-size:14px; opacity:.9; }
    footer { padding:12px 16px; text-align:center; font-size:12px; color:#9aa3b2; }
    .badge { font-weight:700; padding:.3rem .6rem; border-radius:999px; border:1px solid #1f2430; background:#0f1116; }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .rem { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:.5rem .75rem; border-radius:10px; background:#0f1116; border:1px solid #1f2430; }
    .hint { font-size:12px; color:#9aa3b2; margin-top:.5rem; margin-bottom:.25rem; }
  </style>
</head>
<body>
  <header>Pangram Aid</header>
  <main class="wrap">
    <section class="panel">
      <label class="sr-only" for="text">Type your pangram</label>
      <textarea id="text" placeholder="Type here… Every letter exactly once for a perfect pangram."></textarea>
      <div class="totals">
        <div>
          <span class="badge" id="lettersTotal">0</span>
          letters total (<span id="alphabetSize">0</span> in the alphabet)
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="hint">Missing letters (shuffled on load):</div>
      <div class="rem" id="remainShuffled"></div>

      <div class="hint">Missing letters (original order):</div>
      <div class="rem" id="remainOriginal"></div>

      <div class="hint" style="margin-top:1rem;">Per-letter counts:</div>
      <div class="grid" id="grid" aria-live="polite" aria-relevant="all"></div>
    </section>
  </main>

  <footer>
    Edit <code>config.json</code> to change the letters and locale.
  </footer>

  <script>
    // Security: no innerHTML for untrusted data; strict CSP; separate SW file.

    const DEFAULT_CFG = {
      letters: "aąbcćdeęfghijklłmnńoóprsśtuwyzźż",
      locale: "pl-PL"
    };

    const $text = document.getElementById('text');
    const $grid = document.getElementById('grid');
    const $tot  = document.getElementById('lettersTotal');
    const $alphaSize = document.getElementById('alphabetSize');
    const $remainOriginal = document.getElementById('remainOriginal');
    const $remainShuffled = document.getElementById('remainShuffled');

    let letters = Array.from(DEFAULT_CFG.letters);
    let shuffledLetters = [];
    let locale  = DEFAULT_CFG.locale;

    function sanitizeLetters(raw) {
      const seen = new Set();
      const out = [];
      for (const cp of Array.from(String(raw).replace(/\s+/g,''))) {
        if (!seen.has(cp)) { seen.add(cp); out.push(cp); }
      }
      return out.length ? out : Array.from(DEFAULT_CFG.letters);
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function buildGrid() {
      $grid.textContent = '';
      for (const ch of letters) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.setAttribute('role','group');
        cell.setAttribute('aria-label', `Letter ${ch}`);
        cell.dataset.letter = ch;

        const l = document.createElement('div');
        l.className = 'ltr';
        l.textContent = ch;

        const c = document.createElement('div');
        c.className = 'cnt zero';
        c.setAttribute('data-count','');
        c.textContent = '0';

        cell.append(l, c);
        $grid.appendChild(cell);
      }
      $alphaSize.textContent = String(letters.length);
      shuffledLetters = shuffle(letters);
      updateCounts();
    }

    function updateCounts() {
      const txt = ($text.value || '').toLocaleLowerCase(locale);
      const totalLetters = (txt.match(/\p{L}/gu) || []).length;
      $tot.textContent = String(totalLetters);

      const freq = Object.fromEntries(letters.map(l => [l, 0]));
      for (const ch of txt) if (Object.prototype.hasOwnProperty.call(freq, ch)) freq[ch]++;

      // Update per-letter grid
      for (const cell of $grid.children) {
        const ltr = cell.dataset.letter;
        const n = freq[ltr] ?? 0;
        const c = cell.querySelector('[data-count]');
        c.textContent = String(n);
        c.classList.remove('zero','one','many');
        c.classList.add(n===0?'zero':n===1?'one':'many');
        cell.title = `${ltr}: ${n}`;
      }

      // Dynamic remaining strings
      const remainingOriginal = letters.filter(l => (freq[l]||0)===0).join('');
      const remainingShuf = shuffledLetters.filter(l => (freq[l]||0)===0).join('');
      $remainOriginal.textContent = remainingOriginal;
      $remainShuffled.textContent = remainingShuf;
    }

    async function loadConfig() {
      try {
        const res = await fetch('config.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('bad status');
        const cfg = await res.json();
        letters = sanitizeLetters(cfg.letters ?? DEFAULT_CFG.letters);
        locale  = String(cfg.locale || DEFAULT_CFG.locale);
      } catch {
        letters = sanitizeLetters(DEFAULT_CFG.letters);
        locale  = DEFAULT_CFG.locale;
      } finally {
        buildGrid();
      }
    }

    $text.addEventListener('input', updateCounts);
    $text.addEventListener('input', () => {
      $text.style.height = 'auto';
      $text.style.height = $text.scrollHeight + 'px';
    });
    loadConfig();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>